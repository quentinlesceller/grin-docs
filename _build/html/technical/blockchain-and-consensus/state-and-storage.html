

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>State and Storage &mdash; Grin v4.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/toggle.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/js/toggle.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Grin
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Integration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../integration/index.html">Integration</a></li>
</ul>
<p class="caption"><span class="caption-text">Technical Details</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../table-of-contents.html">Table of Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction-to-mimblewimble.html">Technical Introduction to Mimblewimble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grin-for-bitcoiners.html">Grin for Bitcoiners</a></li>
</ul>
<p class="caption"><span class="caption-text">Building Blocks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../building-blocks/merkle-mountain-ranges.html">Merkle Mountain Ranges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building-blocks/merkle-proof.html">Merkle Proof</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building-blocks/switch-commitments.html">Introduction to Switch Commitments</a></li>
</ul>

            
          
    <a href="genindex.html">Keyword Index</a>
  
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Grin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>State and Storage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/technical/blockchain-and-consensus/state-and-storage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="state-and-storage">
<h1>State and Storage<a class="headerlink" href="#state-and-storage" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-grin-state">
<h2>The Grin State<a class="headerlink" href="#the-grin-state" title="Permalink to this headline">¶</a></h2>
<div class="section" id="structure">
<h3>Structure<a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h3>
<p>The full state of a Grin chain consists of all the following data:</p>
<ol class="arabic simple">
<li><p>The full unspent output (UTXO) set.</p></li>
<li><p>The range proof for each output.</p></li>
<li><p>All the transaction kernels.</p></li>
<li><p>A MMR for each of the above (with the exception that the output MMR
includes hashes for <em>all</em> outputs, not only the unspent ones).</p></li>
</ol>
<p>In addition, all headers in the chain are required to anchor the above
state with a valid proof of work (the state corresponds to the most
worked chain). We note that once each range proof is validated and the
sum of all kernels commitment is computed, range proofs and kernels are
not strictly necessary for a node to function anymore.</p>
</div>
<div class="section" id="validation">
<h3>Validation<a class="headerlink" href="#validation" title="Permalink to this headline">¶</a></h3>
<p>With a full Grin state, we can validate the following:</p>
<ol class="arabic simple">
<li><p>The kernel signature is valid against its commitment (public key).
This proves the kernel is valid.</p></li>
<li><p>The sum of all kernel commitments equals the sum of all UTXO
commitments minus the total supply. This proves that kernels and
output commitments are all valid and no coins have unexpectedly been
created.</p></li>
<li><p>All UTXOs, range proofs and kernels hashes are present in their
respective MMR and those MMRs hash to a valid root.</p></li>
<li><p>A known block header with the most work at a given point in time
includes the roots of the 3 MMRs. This validates the MMRs and proves
that the whole state has been produced by the most worked chain.</p></li>
</ol>
</div>
<div class="section" id="mmrs-and-pruning">
<h3>MMRs and Pruning<a class="headerlink" href="#mmrs-and-pruning" title="Permalink to this headline">¶</a></h3>
<p>The data used to produce the hashes for leaf nodes in each MMR (in
addition to their position is the following:</p>
<ul class="simple">
<li><p>The output MMR hashes the feature field and the commitments of all
outputs since genesis.</p></li>
<li><p>The range proof MMR hashes the whole range proof data.</p></li>
<li><p>The kernel MMR hashes all fields of the kernel: feature, fee, lock
height, excess commitment and excess signature.</p></li>
</ul>
<p>Note that all outputs, range proofs and kernels are added in their
respective MMRs in the order they occur in each block (recall that block
data is required to be sorted).</p>
<p>As outputs get spent, both their commitment and range proof data can be
removed. In addition, the corresponding output and range proof MMRs can
be pruned.</p>
</div>
</div>
<div class="section" id="state-storage">
<h2>State Storage<a class="headerlink" href="#state-storage" title="Permalink to this headline">¶</a></h2>
<p>Data storage for outputs, range proofs and kernels in Grin is simple: a
plain append-only file that’s memory-mapped for data access. As outputs
get spent, a remove log maintains which positions can be removed. Those
positions nicely match MMR node positions as they’re all inserted in the
same order. When the remove log gets large, corresponding files can be
occasionally compacted by rewriting them without the removed pieces
(also append-only) and the remove log can be emptied. As for MMRs, we
need to add a little more complexity.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Grin Developers

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book fa-element"> RTD </span>

    <span class="fa fa-element">
    <input class="container_toggle" type="checkbox" id="switch" name="mode">
    <label for="switch"></label>
    </span>

    <span class="fa fa-v fa-element"> v:  <span class="fa fa-caret-down"></span></span>

    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Versions</dt> 
        </dl>
        <dl>
            <dt>Downloads</dt> 
        </dl>
        <dl>
            
            <dt>On Read the Docs</dt>
            <dd>
                <a href="///projects//?fromdocs=">Project Home</a>
            </dd>
            <dd>
                <a href="///builds//?fromdocs=">Builds</a>
            </dd>
        </dl>
    </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>